generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  PROPIETARIO
  INQUILINO
}

enum ContratoEstado {
  ACTIVO
  INACTIVO
}

enum PagoEstado {
  PENDIENTE
  APROBADO
  RECHAZADO
}

enum PagoMetodo {
  MP
  TRANSFERENCIA
}

enum MovimientoTipo {
  CARGO
  PAGO
}

enum TransferenciaEstado {
  PENDIENTE_VERIFICACION
  VERIFICADO
  APROBADO
  RECHAZADO
}

enum DescuentoEstado {
  PENDIENTE
  APROBADO
  RECHAZADO
}

model User {
  id           String        @id @default(cuid())
  email        String        @unique
  passwordHash String
  nombre       String
  apellido     String
  telefono     String?
  dni          String?
  cuitCuil     String?
  rol          UserRole
  cbu          String?
  banco        String?
  mustChangePassword Boolean @default(false)
  createdAt    DateTime      @default(now())
  inmobiliaria   Inmobiliaria? @relation(fields: [inmobiliariaId], references: [id])
  inmobiliariaId String?
  contratosPropietario Contrato[] @relation("PropietarioContratos")
  contratosInquilino   Contrato[] @relation("InquilinoContratos")
  transferenciasVerificadas Transferencia[] @relation("VerificadorTransferencias")
  descuentosSolicitados Descuento[] @relation("InquilinoDescuentos")

  @@index([inmobiliariaId])
}

model Contrato {
  id             String            @id @default(cuid())
  inmobiliaria   Inmobiliaria      @relation(fields: [inmobiliariaId], references: [id])
  inmobiliariaId String
  propietario    User              @relation("PropietarioContratos", fields: [propietarioId], references: [id])
  propietarioId  String
  inquilino      User              @relation("InquilinoContratos", fields: [inquilinoId], references: [id])
  inquilinoId    String
  direccion      String
  montoTotalAlquiler Decimal       @db.Decimal(12, 2) // Monto total que paga el inquilino
  porcentajeComisionInmobiliaria Decimal @db.Decimal(5, 2) @default(0) // Porcentaje de comisión para la inmobiliaria (0-100)
  diaVencimiento Int               @default(10)
  fechaInicio    DateTime
  fechaFin       DateTime
  fechaUltimoAjuste DateTime @default(now())
  ajusteFrecuenciaMeses Int        @default(12)
  estado         ContratoEstado
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  pagos          Pago[]
  archivos       ContratoArchivo[]
  movimientos    Movimiento[]
  descuentos     Descuento[]

  @@index([inmobiliariaId])
  @@index([propietarioId])
  @@index([inquilinoId])
  @@index([estado])
}

model ContratoArchivo {
  id         String   @id @default(cuid())
  contrato   Contrato @relation(fields: [contratoId], references: [id])
  contratoId String
  fileName   String
  filePath   String
  mimeType   String
  uploadedAt DateTime @default(now())

  @@index([contratoId])
}

model Pago {
  id            String         @id @default(cuid())
  contrato      Contrato       @relation(fields: [contratoId], references: [id])
  contratoId    String
  mes           String
  monto         Decimal        @db.Decimal(12, 2)
  comision      Decimal        @db.Decimal(12, 2) @default(0)
  estado        PagoEstado     @default(PENDIENTE)
  fechaPago     DateTime?
  metodoPago    PagoMetodo?
  mpPreferenceId String?
  mpPaymentId    String?
  externalId    String         @unique // ID único para idempotencia (ej: ALQ-202510-<id>)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  movimiento    Movimiento?
  transferencia Transferencia?

  @@unique([contratoId, mes])
  @@index([contratoId])
  @@index([estado])
  @@index([externalId])
}

model Movimiento {
  id          String        @id @default(cuid())
  contrato    Contrato      @relation(fields: [contratoId], references: [id])
  contratoId  String
  tipo        MovimientoTipo
  concepto    String
  monto       Decimal        @db.Decimal(12, 2)
  fecha       DateTime       @default(now())
  pago        Pago?          @relation(fields: [pagoId], references: [id])
  pagoId      String?       @unique

  @@index([contratoId])
  @@index([fecha])
}

model Transferencia {
  id               String              @id @default(cuid())
  pago             Pago                @relation(fields: [pagoId], references: [id])
  pagoId           String              @unique
  comprobantePath  String?             // Solo la imagen del comprobante
  verificado       TransferenciaEstado @default(PENDIENTE_VERIFICACION)
  verificadoPor    User?               @relation("VerificadorTransferencias", fields: [verificadoPorId], references: [id])
  verificadoPorId  String?
  verificadoAt     DateTime?
  comentario       String?
  // IDs de transferencias ejecutadas por super admin
  transferenciaPropietarioId String?
  transferenciaInmobiliariaId String?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([verificado])
}

model Descuento {
  id          String           @id @default(cuid())
  contrato    Contrato         @relation(fields: [contratoId], references: [id])
  contratoId  String
  inquilino   User             @relation("InquilinoDescuentos", fields: [inquilinoId], references: [id])
  inquilinoId String
  monto       Decimal          @db.Decimal(12, 2)
  motivo      String
  estado      DescuentoEstado  @default(PENDIENTE)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([contratoId])
  @@index([estado])
}

model Inmobiliaria {
  id                String    @id @default(cuid())
  nombre            String
  slug              String    @unique
  porcentajeComision Decimal  @default(3.0) @db.Decimal(5, 2) // Porcentaje de comisión (ej: 3.00 para 3%)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  usuarios          User[]
  contratos         Contrato[]
  configuracionPagos ConfiguracionPagos?
}

model ConfiguracionPagos {
  id               String      @id @default(cuid())
  inmobiliaria     Inmobiliaria @relation(fields: [inmobiliariaId], references: [id])
  inmobiliariaId   String      @unique
  cbuDestino       String
  aliasCbu         String?
  banco            String?
  qrCode           String?     // Base64 del QR o URL
  activo           Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
}

model Notificacion {
  id           String    @id @default(cuid())
  tipo         String    // PAGO_APROBADO, PAGO_RECHAZADO, TRANSFERENCIA_VERIFICADA, etc.
  titulo       String
  mensaje      String
  userId       String?   // Si es específica para un usuario
  inmobiliariaId String? // Si es para todos los usuarios de una inmobiliaria
  pagoId       String?   // Si está relacionada con un pago específico
  leida        Boolean   @default(false)
  enviada      Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([inmobiliariaId])
  @@index([pagoId])
  @@index([leida])
  @@index([enviada])
}
